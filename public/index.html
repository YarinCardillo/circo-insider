<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Circo Insider</title>
<link href="https://fonts.googleapis.com/css2?family=Boogaloo&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --red: #B91C1C;
  --red-dark: #7F1D1D;
  --gold: #F59E0B;
  --gold-light: #FCD34D;
  --cream: #FEF3C7;
  --dark: #1C1917;
  --green: #16A34A;
  --blue: #2563EB;
  --purple: #7C3AED;
}
body {
  font-family: 'Quicksand', sans-serif;
  background: var(--dark);
  color: var(--cream);
  min-height: 100dvh;
  overflow-x: hidden;
  background-image:
    repeating-linear-gradient(
      90deg,
      transparent,
      transparent 48px,
      rgba(185,28,28,0.15) 48px,
      rgba(185,28,28,0.15) 50px
    );
}
.screen { display:none; flex-direction:column; align-items:center; justify-content:center; min-height:100dvh; padding:20px; }
.screen.active { display:flex; }

h1 { font-family:'Boogaloo',cursive; color:var(--gold); font-size:2.4em; text-shadow:2px 2px 0 var(--red-dark); text-align:center; }
h2 { font-family:'Boogaloo',cursive; color:var(--gold-light); font-size:1.6em; text-align:center; margin:10px 0; }
h3 { font-family:'Boogaloo',cursive; color:var(--cream); font-size:1.2em; text-align:center; }

.subtitle { color:var(--gold-light); font-size:0.9em; text-align:center; opacity:0.8; margin-bottom:20px; }

input[type="text"] {
  background: rgba(255,255,255,0.1);
  border: 2px solid var(--gold);
  color: var(--cream);
  font-family: 'Quicksand', sans-serif;
  font-size: 1.1em;
  font-weight: 600;
  padding: 16px 18px;
  border-radius: 12px;
  width: 100%;
  max-width: 320px;
  text-align: center;
  outline: none;
  margin: 8px 0;
  min-height: 52px; /* Better for mobile */
  -webkit-appearance: none; /* Remove iOS styling */
}
input::placeholder { color: rgba(254,243,199,0.4); }

.btn {
  font-family: 'Boogaloo', cursive;
  font-size: 1.3em;
  padding: 16px 32px;
  border: none;
  border-radius: 14px;
  cursor: pointer;
  width: 100%;
  max-width: 320px;
  margin: 6px 0;
  transition: transform 0.1s, opacity 0.1s;
  letter-spacing: 0.5px;
  min-height: 52px; /* Better for touch on mobile */
  touch-action: manipulation; /* Prevent double-tap zoom */
}
.btn:active { transform: scale(0.96); }
.btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: var(--dark); }
.btn-red { background: linear-gradient(135deg, var(--red), var(--red-dark)); color: var(--cream); }
.btn-green { background: linear-gradient(135deg, var(--green), #15803D); color: white; }
.btn-blue { background: linear-gradient(135deg, var(--blue), #1D4ED8); color: white; }
.btn-purple { background: linear-gradient(135deg, var(--purple), #6D28D9); color: white; }
.btn-small { font-size: 1em; padding: 12px 20px; max-width: 240px; min-height: 44px; }
.btn:disabled { opacity: 0.4; pointer-events: none; }

.room-code {
  font-family: 'Boogaloo', cursive;
  font-size: 3em;
  color: var(--gold);
  letter-spacing: 8px;
  text-shadow: 2px 2px 0 var(--red-dark);
  background: rgba(255,255,255,0.05);
  padding: 10px 30px;
  border-radius: 12px;
  border: 2px dashed var(--gold);
  margin: 10px 0;
}

.player-list {
  list-style: none;
  width: 100%;
  max-width: 360px;
  max-height: 300px;
  overflow-y: auto;
  margin: 10px 0;
}
.player-list li {
  background: rgba(255,255,255,0.06);
  padding: 10px 16px;
  margin: 4px 0;
  border-radius: 10px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.95em;
}
.player-list li .host-badge {
  background: var(--gold);
  color: var(--dark);
  font-size: 0.7em;
  padding: 2px 8px;
  border-radius: 6px;
  font-weight: 700;
}
.player-list li .score-badge {
  background: rgba(255,255,255,0.1);
  color: var(--gold-light);
  font-size: 0.8em;
  padding: 2px 10px;
  border-radius: 6px;
}

/* Role reveal */
.role-card {
  background: rgba(255,255,255,0.05);
  border: 3px solid var(--gold);
  border-radius: 20px;
  padding: 30px;
  text-align: center;
  max-width: 340px;
  width: 100%;
  margin: 16px 0;
}
.role-card.presentatore { border-color: var(--blue); }
.role-card.infiltrato { border-color: var(--red); }
.role-card.artista { border-color: var(--green); }

.role-icon { font-size: 3.5em; margin-bottom: 10px; }
.role-name {
  font-family: 'Boogaloo', cursive;
  font-size: 2em;
  margin: 8px 0;
}
.role-name.presentatore { color: var(--blue); }
.role-name.infiltrato { color: #EF4444; }
.role-name.artista { color: var(--green); }

.word-reveal {
  font-family: 'Boogaloo', cursive;
  font-size: 2.2em;
  color: var(--gold);
  background: rgba(245,158,11,0.1);
  padding: 12px 24px;
  border-radius: 12px;
  border: 2px solid var(--gold);
  margin: 10px 0;
}

.role-desc {
  font-size: 0.9em;
  opacity: 0.7;
  margin-top: 8px;
  line-height: 1.4;
}

/* Timer */
.timer-container { text-align: center; margin: 16px 0; }
.timer-display {
  font-family: 'Boogaloo', cursive;
  font-size: 4em;
  color: var(--gold);
}
.timer-display.urgent { color: #EF4444; animation: pulse 0.5s infinite alternate; }
.timer-label { font-size: 0.9em; opacity: 0.6; margin-top: 4px; }

@keyframes pulse { from { opacity:1; } to { opacity:0.5; } }

/* Mobile optimizations */
@media (max-width: 400px) {
  h1 { font-size: 2em; }
  h2 { font-size: 1.4em; }
  .btn { font-size: 1.2em; padding: 14px 24px; }
  .room-code { font-size: 2.5em; letter-spacing: 6px; padding: 8px 20px; }
  input[type="text"] { font-size: 1em; }
}

/* Improve mobile Safari compatibility */
@supports (-webkit-touch-callout: none) {
  /* iOS Safari specific */
  .screen { min-height: -webkit-fill-available; }
  input[type="text"] { font-size: 16px; /* Prevent zoom on focus */ }
}

/* Voting */
.vote-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  width: 100%;
  max-width: 360px;
  margin: 12px 0;
  max-height: 50vh;
  overflow-y: auto;
}
.vote-option {
  background: rgba(255,255,255,0.08);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: 12px;
  padding: 16px 10px;
  text-align: center;
  font-weight: 700;
  font-size: 0.95em;
  cursor: pointer;
  transition: all 0.15s;
  min-height: 60px; /* Better touch target */
  display: flex;
  align-items: center;
  justify-content: center;
}
.vote-option:active { transform: scale(0.95); }
.vote-option.selected {
  border-color: var(--red);
  background: rgba(239,68,68,0.2);
  color: #FCA5A5;
}
.vote-option.voted {
  opacity: 0.5;
  pointer-events: none;
}

/* Results */
.result-box {
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 20px;
  width: 100%;
  max-width: 360px;
  margin: 8px 0;
  text-align: center;
}
.result-outcome {
  font-family: 'Boogaloo', cursive;
  font-size: 1.8em;
  margin: 8px 0;
}
.result-outcome.caught { color: var(--green); }
.result-outcome.escaped { color: #EF4444; }

.score-table {
  width: 100%;
  max-width: 360px;
  margin: 8px 0;
}
.score-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 14px;
  margin: 3px 0;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9em;
}
.score-row:nth-child(1) { background: rgba(245,158,11,0.2); }
.score-row:nth-child(2) { background: rgba(255,255,255,0.08); }
.score-row:nth-child(3) { background: rgba(255,255,255,0.05); }
.score-row .pts { color: var(--gold-light); font-family: 'Boogaloo', cursive; font-size: 1.1em; }

.tally-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 0.85em;
  opacity: 0.8;
}

.info-text { font-size: 0.85em; opacity: 0.6; text-align: center; max-width: 320px; line-height: 1.4; }
.vote-status { font-size: 0.9em; opacity: 0.7; text-align:center; margin: 6px 0; }

.spacer { height: 10px; }
.divider { width: 60px; height: 3px; background: var(--gold); border-radius: 2px; margin: 12px auto; opacity: 0.3; }

/* Toast */
.toast {
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%) translateY(150px);
  background: var(--red);
  color: white;
  padding: 16px 28px;
  border-radius: 14px;
  font-weight: 700;
  font-size: 1em;
  z-index: 9999;
  transition: transform 0.3s ease;
  text-align: center;
  max-width: 90%;
  min-height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- HOME -->
<div id="screen-home" class="screen active">
  <h1>CIRCO<br>INSIDER</h1>
  <p class="subtitle">Trova l'Infiltrato tra gli Artisti</p>
  <div class="spacer"></div>
  <input type="text" id="player-name" placeholder="Il tuo nome" maxlength="16" autocomplete="off">
  <div class="spacer"></div>
  <button class="btn btn-gold" id="btn-create-room">Crea Stanza</button>
  <button class="btn btn-red" id="btn-show-join">Entra in Stanza</button>
  <div id="join-section" style="display:none; width:100%; max-width:320px; text-align:center;">
    <input type="text" id="room-code-input" placeholder="Codice stanza" maxlength="4" style="text-transform:uppercase">
    <button class="btn btn-gold btn-small" id="btn-join-room">Entra</button>
  </div>
</div>

<!-- LOBBY -->
<div id="screen-lobby" class="screen">
  <h2>Tendone del Circo</h2>
  <div class="room-code" id="lobby-code"></div>
  <p class="info-text">Condividi il codice con gli altri giocatori</p>
  <div class="divider"></div>
  <h3 id="player-count-label">Giocatori (0)</h3>
  <ul class="player-list" id="lobby-players"></ul>
  <p class="info-text" id="round-info"></p>
  <div class="spacer"></div>
  <button class="btn btn-gold" id="btn-start" style="display:none">Inizia Round</button>
  <button class="btn btn-red btn-small" id="btn-reset" style="display:none">Reset Punteggi</button>
  <button class="btn btn-red btn-small" id="btn-leave-room">Esci dalla Stanza</button>
</div>

<!-- ROLE REVEAL -->
<div id="screen-reveal" class="screen">
  <h2 id="reveal-round">Round 1/5</h2>
  <div class="role-card" id="role-card">
    <div class="role-icon" id="role-icon"></div>
    <div class="role-name" id="role-name"></div>
    <div id="word-container"></div>
    <div class="role-desc" id="role-desc"></div>
  </div>
  <p class="info-text">Memorizza il tuo ruolo! Si parte tra poco...</p>
</div>

<!-- GUESSING PHASE -->
<div id="screen-guessing" class="screen">
  <h2>Fate Domande!</h2>
  <p class="info-text">Il Presentatore risponde solo SI o NO.<br>L'Infiltrato conosce la parola e vi guida di nascosto.</p>
  <div class="divider"></div>
  <div class="timer-container">
    <div class="timer-display" id="guess-timer">5:00</div>
    <div class="timer-label">Tempo per indovinare</div>
  </div>
  <div class="spacer"></div>
  <div id="host-guess-buttons" style="display:none;">
    <button class="btn btn-green" id="btn-word-guessed">Parola Indovinata!</button>
    <div class="spacer"></div>
    <button class="btn btn-red btn-small" id="btn-time-up">Tempo Scaduto</button>
  </div>
  <p class="info-text" id="guess-wait" style="display:none;">In attesa che l'host confermi...</p>
</div>

<!-- DISCUSSION -->
<div id="screen-discussion" class="screen">
  <h2>Parola Indovinata!</h2>
  <div class="word-reveal" id="discussion-word"></div>
  <div class="divider"></div>
  <h3>Chi era l'Infiltrato?</h3>
  <p class="info-text">Discutete! Chi ha guidato il gruppo verso la risposta?<br>Chi faceva domande troppo mirate?</p>
  <div class="timer-container">
    <div class="timer-display" id="discuss-timer">1:30</div>
    <div class="timer-label">Discussione</div>
  </div>
  <button class="btn btn-gold btn-small" id="btn-force-voting" style="display:none">Apri Voto Subito</button>
  <p class="info-text" id="discussion-auto-msg">Il voto si apre automaticamente...</p>
</div>

<!-- VOTING -->
<div id="screen-voting" class="screen">
  <h2>Chi e' l'Infiltrato?</h2>
  <p class="info-text">Vota chi pensi sia l'Infiltrato.<br>Non puoi votare il Presentatore.</p>
  <div class="vote-grid" id="vote-grid"></div>
  <button class="btn btn-red" id="btn-confirm-vote" style="display:none">Conferma Voto</button>
  <p class="vote-status" id="vote-status"></p>
  <div class="timer-container">
    <div class="timer-display" id="vote-timer" style="font-size:2em">1:00</div>
  </div>
  <button class="btn btn-gold btn-small" id="btn-force-results" style="display:none">Chiudi Voto</button>
</div>

<!-- RESULTS -->
<div id="screen-results" class="screen">
  <h2 id="results-round">Risultati Round 1</h2>

  <div class="result-box">
    <p style="font-size:0.85em; opacity:0.6;">La parola era</p>
    <div class="word-reveal" id="results-word" style="font-size:1.6em;"></div>
  </div>

  <div class="result-box">
    <p style="font-size:0.85em; opacity:0.6;">Il Presentatore era</p>
    <p style="font-size:1.2em; font-weight:700; color:var(--blue);" id="results-presentatore"></p>
    <div class="divider"></div>
    <p style="font-size:0.85em; opacity:0.6;">L'Infiltrato era</p>
    <p style="font-size:1.2em; font-weight:700; color:#EF4444;" id="results-infiltrati"></p>
  </div>

  <div class="result-box" id="results-outcome-box">
    <div class="result-outcome" id="results-outcome"></div>
    <p class="info-text" id="results-detail"></p>
  </div>

  <div class="result-box" id="results-votes-box" style="display:none;">
    <p style="font-size:0.85em; opacity:0.6; margin-bottom:8px;">Voti</p>
    <div id="results-tally"></div>
  </div>

  <h3 style="margin-top:10px;">Classifica</h3>
  <div class="score-table" id="results-scores"></div>

  <div class="spacer"></div>
  <button class="btn btn-gold" id="btn-next-round" style="display:none">Prossimo Round</button>
  <button class="btn btn-blue btn-small" id="btn-back-lobby" style="display:none">Torna alla Lobby</button>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- DEBUG PANEL (mobile-optimized) -->
<div id="debug-panel" style="position:fixed; top:0; left:0; right:0; background:rgba(0,0,0,0.98); color:#0f0; font-family:monospace; font-size:14px; padding:12px; max-height:250px; overflow-y:auto; z-index:999999; display:none; border-bottom:4px solid #0f0; box-shadow:0 4px 12px rgba(0,0,0,0.5);">
  <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
    <span id="debug-status" style="font-weight:bold; font-size:16px;">‚ö™ Status</span>
    <button id="debug-close-btn" style="background:#f00; color:#fff; border:none; padding:10px 20px; font-size:16px; border-radius:8px; cursor:pointer; font-weight:bold; min-width:70px; min-height:50px;">CHIUDI</button>
  </div>
  <pre id="debug-logs" style="margin:0; font-size:12px; white-space:pre-wrap; word-wrap:break-word; line-height:1.4;"></pre>
</div>
<button id="debug-open-btn" style="position:fixed; top:10px; right:10px; background:#0f0; color:#000; border:3px solid #000; padding:12px 20px; font-size:16px; z-index:999998; border-radius:10px; font-weight:bold; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.5); min-width:100px; min-height:60px; touch-action:manipulation;">DEBUG</button>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io({ reconnection: true, reconnectionAttempts: 10, reconnectionDelay: 2000 });

let myId = null;
let roomCode = null;
let isHost = false;
let selectedVote = null;
let hasVoted = false;
let timerInterval = null;

// Debug logger for mobile (safe DOM methods)
const debugHistory = [];
function debugLog(msg) {
  const time = new Date().toLocaleTimeString();
  const logMsg = '[' + time + '] ' + msg;
  debugHistory.unshift(logMsg);
  if (debugHistory.length > 10) debugHistory.pop();

  const logs = document.getElementById('debug-logs');
  if (logs) {
    logs.textContent = debugHistory.join('\n');
  }
  console.log(msg);
}

function updateDebugStatus(status, color) {
  const statusEl = document.getElementById('debug-status');
  if (statusEl) {
    statusEl.textContent = status;
    statusEl.style.color = color;
  }
}

// ---- URL PARAMS ----
const params = new URLSearchParams(window.location.search);
if (params.get('room')) {
  document.getElementById('room-code-input').value = params.get('room');
  showJoin();
}

// ---- NAVIGATION ----
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ---- HOME ----
function showJoin() {
  document.getElementById('join-section').style.display = 'block';
}

function getName() {
  const name = document.getElementById('player-name').value.trim();
  if (!name) { toast('Inserisci un nome!'); return null; }
  return name;
}

function createRoom() {
  debugLog('[BTN] Create room clicked');
  const name = getName();
  if (!name) {
    debugLog('[WARN] No name');
    return;
  }

  debugLog('[CHK] connected=' + socket.connected + ' id=' + (socket.id ? socket.id.substring(0,8) : 'null'));

  if (!socket.connected) {
    toast('Connessione in corso... Riprova tra un attimo.');
    debugLog('[BLOCK] Not connected');
    return;
  }

  debugLog('[SEND] create_room: ' + name);
  socket.emit('create_room', name);
}

function joinRoom() {
  const name = getName();
  if (!name) return;

  const code = document.getElementById('room-code-input').value.trim().toUpperCase();
  if (code.length !== 4) {
    toast('Codice stanza non valido!');
    return;
  }

  if (!socket.connected) {
    toast('Connessione in corso... Riprova tra un attimo.');
    console.warn('[WARN] Socket not connected, cannot join room');
    return;
  }

  console.log('[SEND] join_room:', { code, name });
  socket.emit('join_room', { code, name });
}

// ---- LOBBY ----
function updateLobby(players, round, totalRounds) {
  document.getElementById('lobby-code').textContent = roomCode;
  document.getElementById('player-count-label').textContent = `Giocatori (${players.length})`;

  const list = document.getElementById('lobby-players');
  list.innerHTML = '';
  players.forEach(p => {
    const li = document.createElement('li');
    let badges = '';
    if (p.isHost) badges += '<span class="host-badge">HOST</span> ';
    badges += `<span class="score-badge">${p.score} pt</span>`;
    li.innerHTML = `<span>${p.name}</span><span>${badges}</span>`;
    list.appendChild(li);
  });

  const r = round || 0;
  const tr = totalRounds || 5;
  document.getElementById('round-info').textContent = r > 0 ? `Round ${r}/${tr} completato` : 'Pronto per iniziare';

  document.getElementById('btn-start').style.display = isHost ? 'block' : 'none';
  document.getElementById('btn-reset').style.display = (isHost && r > 0) ? 'block' : 'none';

  if (isHost) {
    document.getElementById('btn-start').textContent = r >= tr ? 'Partita Finita!' : (r > 0 ? 'Prossimo Round' : 'Inizia Round');
    document.getElementById('btn-start').disabled = r >= tr;
  }
}

// ---- TIMER ----
function startTimer(elementId, seconds, onEnd) {
  clearInterval(timerInterval);
  const el = document.getElementById(elementId);
  let remaining = seconds;

  function update() {
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    el.textContent = `${m}:${s.toString().padStart(2, '0')}`;
    el.classList.toggle('urgent', remaining <= 30);
    if (remaining <= 0) {
      clearInterval(timerInterval);
      if (onEnd) onEnd();
    }
    remaining--;
  }

  update();
  timerInterval = setInterval(update, 1000);
}

// ---- GAME ACTIONS ----
function startRound() {
  socket.emit('start_round');
}

function wordGuessed() {
  socket.emit('word_guessed');
}

function timeUp() {
  socket.emit('time_up');
}

function confirmVote() {
  if (!selectedVote || hasVoted) return;
  hasVoted = true;
  socket.emit('vote', { targetId: selectedVote });
  document.querySelectorAll('.vote-option').forEach(el => el.classList.add('voted'));
  document.getElementById('btn-confirm-vote').style.display = 'none';
  toast('Voto registrato!');
}

function forceResults() {
  socket.emit('force_results');
}

function forceVoting() {
  socket.emit('force_voting');
}

function backToLobby() {
  socket.emit('back_to_lobby');
}

function resetGame() {
  if (confirm('Resettare tutti i punteggi?')) {
    socket.emit('reset_game');
  }
}

function leaveRoom() {
  if (confirm('Vuoi davvero uscire dalla stanza?')) {
    socket.emit('leave_room');
    roomCode = null;
    isHost = false;
    showScreen('home');
    toast('Sei uscito dalla stanza');
  }
}

// ---- SOCKET EVENTS ----
socket.on('connect', () => {
  myId = socket.id;
  debugLog('[OK] Connected, ID: ' + socket.id.substring(0, 8));
  updateDebugStatus('üü¢ Connected', '#0f0');
});

socket.on('connect_error', (error) => {
  debugLog('[ERROR] Conn error: ' + (error.message || error.toString()));
  updateDebugStatus('üî¥ Conn Error', '#f00');
  toast('Errore di connessione al server! Riprova...');
});

socket.on('disconnect', (reason) => {
  debugLog('[WARN] Disconnected: ' + reason);
  updateDebugStatus('üü° Disconnected', '#ff0');
  if (reason === 'io server disconnect') {
    socket.connect();
  }
  toast('Connessione persa. Riconnessione...');
});

socket.on('reconnect', (attemptNumber) => {
  debugLog('[OK] Reconnected (attempt ' + attemptNumber + ')');
  updateDebugStatus('üü¢ Reconnected', '#0f0');
  toast('Riconnesso al server!');
});

socket.on('room_created', ({ code, players }) => {
  debugLog('[RECV] room_created: ' + code);
  roomCode = code;
  isHost = true;
  showScreen('lobby');
  updateLobby(players);
});

socket.on('room_joined', ({ code, players, isHost: host }) => {
  debugLog('[RECV] room_joined: ' + code);
  roomCode = code;
  isHost = host;
  showScreen('lobby');
  updateLobby(players);
});

socket.on('player_list', (players) => {
  updateLobby(players);
});

socket.on('new_host', (hostId) => {
  isHost = (hostId === myId);
  debugLog('[RECV] new_host: ' + (isHost ? 'you' : 'other'));
  toast(isHost ? 'Sei il nuovo host!' : '');
});

socket.on('error_msg', (msg) => {
  debugLog('[RECV] error: ' + msg);
  toast(msg);
});

socket.on('role_assigned', ({ role, word, round, totalRounds }) => {
  showScreen('reveal');
  document.getElementById('reveal-round').textContent = `Round ${round}/${totalRounds}`;

  const card = document.getElementById('role-card');
  card.className = 'role-card ' + role;

  const icon = document.getElementById('role-icon');
  const name = document.getElementById('role-name');
  const desc = document.getElementById('role-desc');
  const wordContainer = document.getElementById('word-container');

  name.className = 'role-name ' + role;

  if (role === 'presentatore') {
    icon.textContent = 'üé©';
    name.textContent = 'IL PRESENTATORE';
    wordContainer.innerHTML = `<div class="word-reveal">${word}</div>`;
    desc.textContent = 'Rispondi solo SI o NO alle domande del gruppo. Non dare troppi indizi!';
  } else if (role === 'infiltrato') {
    icon.textContent = 'üÉè';
    name.textContent = "L'INFILTRATO";
    wordContainer.innerHTML = `<div class="word-reveal">${word}</div>`;
    desc.textContent = 'Conosci la parola! Guida il gruppo verso la risposta senza farti scoprire.';
  } else {
    icon.textContent = 'üé™';
    name.textContent = 'ARTISTA';
    wordContainer.innerHTML = '';
    desc.textContent = 'Fai domande SI/NO al Presentatore per indovinare la parola. Poi trova l\'Infiltrato!';
  }
});

socket.on('phase_change', ({ phase, duration, word, candidates }) => {
  clearInterval(timerInterval);

  if (phase === 'guessing') {
    showScreen('guessing');
    startTimer('guess-timer', duration);
    document.getElementById('host-guess-buttons').style.display = isHost ? 'block' : 'none';
    document.getElementById('guess-wait').style.display = isHost ? 'none' : 'block';
  }

  if (phase === 'discussion') {
    showScreen('discussion');
    document.getElementById('discussion-word').textContent = word;
    document.getElementById('btn-force-voting').style.display = isHost ? 'block' : 'none';
    document.getElementById('discussion-auto-msg').style.display = isHost ? 'none' : 'block';
    startTimer('discuss-timer', duration);
  }

  if (phase === 'voting') {
    showScreen('voting');
    selectedVote = null;
    hasVoted = false;
    document.getElementById('btn-confirm-vote').style.display = 'none';
    document.getElementById('btn-force-results').style.display = isHost ? 'block' : 'none';
    document.getElementById('vote-status').textContent = '';

    const grid = document.getElementById('vote-grid');
    grid.innerHTML = '';
    candidates.forEach(c => {
      const div = document.createElement('div');
      div.className = 'vote-option';
      div.textContent = c.name;
      div.dataset.id = c.id;
      div.onclick = () => selectVote(div, c.id);
      grid.appendChild(div);
    });

    startTimer('vote-timer', duration, () => {
      if (isHost) forceResults();
    });
  }
});

function selectVote(el, id) {
  if (hasVoted) return;
  if (id === myId) { toast('Non puoi votare te stesso!'); return; }
  document.querySelectorAll('.vote-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedVote = id;
  document.getElementById('btn-confirm-vote').style.display = 'block';
}

socket.on('vote_count', ({ current, total }) => {
  document.getElementById('vote-status').textContent = `Voti: ${current}/${total}`;
});

socket.on('round_results', (data) => {
  clearInterval(timerInterval);
  showScreen('results');

  document.getElementById('results-round').textContent = `Risultati Round ${data.round}`;
  document.getElementById('results-word').textContent = data.word;
  document.getElementById('results-presentatore').textContent = data.presentatore;
  document.getElementById('results-infiltrati').textContent = data.infiltrati.join(', ');

  const outcomeEl = document.getElementById('results-outcome');
  const detailEl = document.getElementById('results-detail');

  if (!data.wordGuessed) {
    outcomeEl.className = 'result-outcome escaped';
    outcomeEl.textContent = 'Tempo Scaduto!';
    detailEl.textContent = "L'Infiltrato vince - nessuno ha indovinato la parola!";
  } else if (data.infiltratiCaught) {
    outcomeEl.className = 'result-outcome caught';
    outcomeEl.textContent = 'Infiltrato Smascherato!';
    detailEl.textContent = `${data.mostVoted} era l'Infiltrato! Il Circo vince!`;
  } else {
    outcomeEl.className = 'result-outcome escaped';
    outcomeEl.textContent = "L'Infiltrato Sfugge!";
    detailEl.textContent = `Avete votato ${data.mostVoted || 'nessuno'}, ma non era l'Infiltrato!`;
  }

  // Vote tally
  const tallyBox = document.getElementById('results-votes-box');
  const tallyDiv = document.getElementById('results-tally');
  if (data.voteTally && Object.keys(data.voteTally).length > 0) {
    tallyBox.style.display = 'block';
    tallyDiv.innerHTML = '';
    const sorted = Object.entries(data.voteTally).sort((a, b) => b[1] - a[1]);
    sorted.forEach(([name, count]) => {
      const row = document.createElement('div');
      row.className = 'tally-row';
      row.innerHTML = `<span>${name}</span><span>${count} vot${count === 1 ? 'o' : 'i'}</span>`;
      tallyDiv.appendChild(row);
    });
  } else {
    tallyBox.style.display = 'none';
  }

  // Scores
  const scoresDiv = document.getElementById('results-scores');
  scoresDiv.innerHTML = '';
  data.scores.forEach((s, i) => {
    const row = document.createElement('div');
    row.className = 'score-row';
    const medal = i === 0 ? 'ü•á ' : i === 1 ? 'ü•à ' : i === 2 ? 'ü•â ' : '';
    row.innerHTML = `<span>${medal}${s.name}</span><span class="pts">${s.score} pt</span>`;
    scoresDiv.appendChild(row);
  });

  // Host buttons
  document.getElementById('btn-next-round').style.display = isHost && data.round < data.totalRounds ? 'block' : 'none';
  document.getElementById('btn-back-lobby').style.display = isHost ? 'block' : 'none';
});

socket.on('back_to_lobby', ({ players, round, totalRounds }) => {
  showScreen('lobby');
  updateLobby(players, round, totalRounds);
});

socket.on('game_reset', ({ players }) => {
  showScreen('lobby');
  updateLobby(players, 0, 5);
  toast('Punteggi resettati!');
});

// CRITICAL: Wait for DOM to be fully loaded before attaching event listeners
// This ensures all elements exist before we try to attach listeners
document.addEventListener('DOMContentLoaded', function() {
  console.log('[INIT] DOM loaded, attaching event listeners...');

  // Debug panel controls (proper event listeners for mobile)
  const debugOpenBtn = document.getElementById('debug-open-btn');
  const debugCloseBtn = document.getElementById('debug-close-btn');

  if (debugOpenBtn) {
    debugOpenBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('debug-panel').style.display = 'block';
      debugLog('[UI] Debug panel opened');
    });
    console.log('[INIT] Debug open button listener attached');
  } else {
    console.error('[ERROR] debug-open-btn NOT FOUND');
  }

  if (debugCloseBtn) {
    debugCloseBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('debug-panel').style.display = 'none';
    });
    console.log('[INIT] Debug close button listener attached');
  } else {
    console.error('[ERROR] debug-close-btn NOT FOUND');
  }

  // ALL GAME BUTTONS - proper event listeners for Safari mobile compatibility
  const buttonMappings = [
    { id: 'btn-create-room', handler: createRoom },
    { id: 'btn-show-join', handler: showJoin },
    { id: 'btn-join-room', handler: joinRoom },
    { id: 'btn-start', handler: startRound },
    { id: 'btn-reset', handler: resetGame },
    { id: 'btn-leave-room', handler: leaveRoom },
    { id: 'btn-word-guessed', handler: wordGuessed },
    { id: 'btn-time-up', handler: timeUp },
    { id: 'btn-force-voting', handler: forceVoting },
    { id: 'btn-confirm-vote', handler: confirmVote },
    { id: 'btn-force-results', handler: forceResults },
    { id: 'btn-next-round', handler: startRound },
    { id: 'btn-back-lobby', handler: backToLobby }
  ];

  buttonMappings.forEach(({ id, handler }) => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.addEventListener('click', handler);
      console.log('[INIT] Listener attached:', id);
    } else {
      console.error('[ERROR] Button NOT FOUND:', id);
    }
  });

  // Enter key support for inputs
  const playerNameInput = document.getElementById('player-name');
  if (playerNameInput) {
    playerNameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const joinVisible = document.getElementById('join-section').style.display !== 'none';
        if (joinVisible) {
          document.getElementById('room-code-input').focus();
        } else {
          createRoom();
        }
      }
    });
    console.log('[INIT] Player name Enter key listener attached');
  }

  const roomCodeInput = document.getElementById('room-code-input');
  if (roomCodeInput) {
    roomCodeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        joinRoom();
      }
    });
    console.log('[INIT] Room code Enter key listener attached');
  }

  debugLog('[INIT] All event listeners attached successfully');
  console.log('[INIT] Event listener setup complete');
});

// Prevent double-tap zoom (but NOT on debug button)
document.addEventListener('touchend', (e) => {
  if (e.target.id === 'debug-open-btn' || e.target.id === 'debug-close-btn') {
    return; // Allow debug buttons to work
  }
  if (e.target.tagName === 'BUTTON' || e.target.classList.contains('vote-option')) {
    e.preventDefault();
  }
}, { passive: false });
</script>
</body>
</html>
